name: CI & Deploy (Vercel + Cloudflare + Telegram)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  DEPLOY_DOMAIN: "https://mini.boomchainlab.com"
  TELEGRAM_WEBHOOK_PATH: "/api/telegram/webhook"

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      build-ok: ${{ steps.build-outcome.outputs.ok }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install pnpm
        run: npm i -g pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        id: build-outcome
        run: |
          pnpm build
          echo "::set-output name=ok::true"

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: needs.build.outputs.build-ok == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Vercel Deploy (production)
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./
          prod: true

      - name: Wait for deployment propagation
        run: sleep 8

      - name: Cloudflare: Purge cache (optional)
        if: secrets.CLOUDFLARE_API_TOKEN != ''
        env:
          CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          if [ -z "${{ secrets.CLOUDFLARE_ZONE_ID }}" ]; then
            echo "No CLOUDFLARE_ZONE_ID set, skipping purge"
          else
            curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
              -H "Authorization: Bearer ${CF_API_TOKEN}" \
              -H "Content-Type: application/json" \
              --data '{"purge_everything":true}'
          fi

      - name: Set Telegram webhook to backend (optional)
        if: secrets.TELEGRAM_BOT_TOKEN != ''
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          BACKEND_WEBHOOK="${{ env.DEPLOY_DOMAIN }}${{ env.TELEGRAM_WEBHOOK_PATH }}"
          echo "Setting Telegram webhook to $BACKEND_WEBHOOK"
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/setWebhook" \
            -d "url=${BACKEND_WEBHOOK}" \
            -d "max_connections=40"

      - name: Post-deploy: notify admin chat (Telegram)
        if: secrets.TELEGRAM_BOT_TOKEN != '' && secrets.TELEGRAM_ADMIN_CHAT_ID != ''
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_ADMIN_CHAT_ID: ${{ secrets.TELEGRAM_ADMIN_CHAT_ID }}
        run: |
          DEPLOY_INFO="âœ… Deployment finished: ${DEPLOY_DOMAIN}\nRepo: $GITHUB_REPOSITORY\nRef: $GITHUB_REF\nSHA: $GITHUB_SHA"
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id=${TELEGRAM_ADMIN_CHAT_ID} \
            -d parse_mode=Markdown \
            -d text="$DEPLOY_INFO"

      - name: Notify internal hook (optional)
        if: secrets.INTERNAL_DEPLOY_HOOK != ''
        run: |
          curl -X POST "${{ secrets.INTERNAL_DEPLOY_HOOK }}" \
            -H "Content-Type: application/json" \
            -d "{\"repo\":\"$GITHUB_REPOSITORY\",\"ref\":\"$GITHUB_REF\",\"url\":\"${{ env.DEPLOY_DOMAIN }}\"}"
